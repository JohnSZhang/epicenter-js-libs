'use strict';
/**
 * ##State API Adapter
 *
 * The State API Adapter allows you to replay or clone runs
 *
 */

var ConfigService = require('./configuration-service');
var TransportFactory = require('../transport/http-transport-factory');
var _pick = require('../util/object-util')._pick;
var apiEndpoint = 'model/state';

module.exports = function (config) {

    var defaults = {

    };

    var serviceOptions = $.extend({}, defaults, config);
    var urlConfig = new ConfigService(serviceOptions).get('server');

    var transportOptions = $.extend(true, {}, serviceOptions.transport, {
        url: urlConfig.getAPIPath(apiEndpoint)
    });

    if (serviceOptions.token) {
        transportOptions.headers = {
            'Authorization': 'Bearer ' + serviceOptions.token
        };
    }

    var http = new TransportFactory(transportOptions);

    var publicAPI = {
        /**
        * Replays a run to get it back into memory
        *
        *
        * **PARAMETERS**
        * @param {object} `params` Parameters object
        * @param {string} `params.runId` id of the run to bring back to memory
        * @param {string} (Optional) `param.stopBefore` - the run is advanced only up to the first occurrence of that method
        * @param {object} (Optional) `options` - Options override
        */
        replay: function (params, options) {
            var replayOptions = $.extend(true, {},
                serviceOptions,
                options,
                { url: urlConfig.getAPIPath(apiEndpoint) + params.runId }
            );

            params = $.extend(true, { action: 'replay' }, _pick(params, 'stopBefore'));

            return http.post(params, replayOptions);
        },

        /**
        * Clones a given run and returns a new run in the same state as the given run
        *
        *
        * **PARAMETERS**
        * @param {object} `params` Parameters object
        * @param {string} `params.runId` id of the run to bring back to memory
        * @param {string} (Optional) `param.stopBefore` - the run is advanced only up to the first occurrence of that method
        * @param {object} (Optional) `options` - Options override
        */
        clone: function (params, options) {
            var replayOptions = $.extend(true, {},
                serviceOptions,
                options,
                { url: urlConfig.getAPIPath(apiEndpoint) + params.runId }
            );

            params = $.extend(true, { action: 'clone' }, _pick(params, 'stopBefore'));

            return http.post(params, replayOptions);
        }
    };

    $.extend(this, publicAPI);
};